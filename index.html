<!DOCTYPE html>
<!-- refs : http://www.codicode.com/art/undo_and_redo_to_the_html5_canvas.aspx -->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="text/javascript" src="./javascripts/jquery-2.1.0.min.js"></script>
    <title>선 그리기</title>
    <style>
      .container {
        text-align: center;
      }

      .source {
        height: 420px;
        display: inline-block;
      }

      .source .img {
        display: block;
        margin-top: 20px;
        margin-bottom: 20px;
      }

      .canvas {
        display: inline-block;
      }

      .destination {
        height: 420px;
        display: inline-block;
      }

      .destination .img {
        display: block;
        margin-top: 18px;
        margin-bottom: 18px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="source">
        <!-- 시작하는 점 -->
        <img id='s0' class='srcImg img' src="./images/a.png" width='100' height='100'>
        <img id='s1' class='srcImg img' src="./images/a.png" width='100' height='100'>
        <img id='s2' class='srcImg img' src="./images/a.png" width='100' height='100'>
      </div>
      <!-- CANVAS -->
      <canvas class="canvas" id="lineCanvas" width="400px" height="420px"></canvas>

      <div class="destination">
        <!-- 종료하는 점 -->
        <img id='d0' class='destImg img' src="./images/b.png" width='93' height='104'>
        <img id='d1' class='destImg img' src="./images/b.png" width='93' height='104'>
        <img id='d2' class='destImg img' src="./images/b.png" width='93' height='104'>
        
      </div>
    </div>

    <script>
      $(document).ready(function() {
        init();
        initEvent();
      });

      var source = {
        // s1: { id: 's1', x: 0, y: 78 },
        // s2: { id: 's2', x: 0, y: 198 },
        // s3: { id: 's3', x: 0, y: 318 },
      };

      var dest = {
        // d1: { id: 'd1', x: 400, y: 78 },
        // d2: { id: 'd2', x: 400, y: 200 },
        // d3: { id: 'd3', x: 400, y: 322 },
      };

      var canvas;
      var context;
      var pointObj = {};
      var userAnswer = {};

      function init() {
        canvas = document.getElementById('lineCanvas');
        context = canvas.getContext('2d');

        var srcImages = $('.srcImg');
        var destImages = $('.destImg');

        console.log(srcImages);
        console.log(destImages);


        for (i = 0, j = srcImages.length; i < j; i++) {
          source[srcImages[i].id] = {
            id: srcImages[i].id,
            x: 0,
            y: srcImages[i].offsetTop + (srcImages[i].height / 2)
          };
        }

        for (i = 0, j = destImages.length; i < j; i++) {
          dest[destImages[i].id] = {
            id: destImages[i].id,
            x: 400,
            y: destImages[i].offsetTop + (destImages[i].height / 2)
          };
        }

        // console.log(source);
        // console.log(dest);
      }

      function initEvent() {

        $('.img').mouseenter(function(e) {
          $(this).css('background', '#ccc');
        });;

        $('.img').mouseleave(function(e) {
          $(this).css('background', '#fff');
        });

        $('.srcImg').click(function(e) {
          pointObj.startItem = source[$(this).attr('id')];
        });

        $('.destImg').click(function(e) {
          if (pointObj.startItem) {
            pointObj.endItem = dest[$(this).attr('id')];
            drawLine(pointObj);
          }
        });
      }

      function drawLine(obj) {
        console.log("POINT : " + JSON.stringify(obj));
        if (obj) {
          // 기존에 표현한 선이 있으면 지움.
          if (userAnswer[obj.startItem.id] && obj.endItem.id !== userAnswer[obj.startItem.id]) {
            var endPoint = dest[userAnswer[obj.startItem.id]];
            context.beginPath();
            context.strokeStyle = "#fff";
            context.lineWidth = 7;
            context.lineJoin = "round";
            context.moveTo(obj.startItem.x, obj.startItem.y);
            context.lineTo(endPoint.x, endPoint.y);
            context.closePath();
            context.stroke();  
          }

          // 선긋기
          context.beginPath();
          context.strokeStyle = "#222222";
          context.lineWidth = 5;
          context.lineJoin = "round";
          context.moveTo(obj.startItem.x, obj.startItem.y);
          context.lineTo(obj.endItem.x, obj.endItem.y);
          context.closePath();
          context.stroke();

          // 사용자 answer 저장
          userAnswer[obj.startItem.id] = obj.endItem.id;
          console.log('User Answer : ' + JSON.stringify(userAnswer));

          // 초기화
          pointObj = {};
        }
      }
    </script>
  </body>
</html>
